name: CI

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run lint

    format:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check Prettier formatting
              run: bun run format:check

    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run security audit
              run: bun audit

    type-check:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Type check with TypeScript
              run: bun run type-check

    build:
        name: Build Executable
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build executable
              run: bun run build

            - name: Verify executable exists
              run: test -f ./dist/devflow

            - name: Check executable size
              run: |
                  SIZE=$(stat -f%z ./dist/devflow 2>/dev/null || stat -c%s ./dist/devflow)
                  echo "Executable size: $(numfmt --to=iec-i --suffix=B $SIZE)"
                  if [ $SIZE -gt 104857600 ]; then
                    echo "Warning: Executable size exceeds 100MB"
                    exit 1
                  fi

            - name: Upload executable artifact
              uses: actions/upload-artifact@v4
              with:
                  name: devflow-executable
                  path: ./dist/devflow
                  retention-days: 7

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests with coverage
              run: bun run test:coverage
              continue-on-error: false

            - name: Check test performance
              run: bun run test:perf
              continue-on-error: true

            - name: Upload performance report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: performance-report
                  path: .bun-test/results.xml
              continue-on-error: true

            - name: Upload coverage artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: coverage/
              continue-on-error: true

    circular-deps:
        name: Circular Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check for circular dependencies
              run: bun run check:circular:ci

    knip:
        name: Unused Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check for unused dependencies
              run: bun run knip

    ci-status:
        name: CI Status
        runs-on: ubuntu-latest
        needs:
            [
                lint,
                format,
                type-check,
                build,
                test,
                security-audit,
                circular-deps,
                knip,
            ]
        if: always()
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check CI status
              run: |
                  if [[ "${{ needs.lint.result }}" == "failure" || \
                        "${{ needs.format.result }}" == "failure" || \
                        "${{ needs.type-check.result }}" == "failure" || \
                        "${{ needs.build.result }}" == "failure" || \
                        "${{ needs.test.result }}" == "failure" || \
                        "${{ needs.security-audit.result }}" == "failure" || \
                        "${{ needs.circular-deps.result }}" == "failure" || \
                        "${{ needs.knip.result }}" == "failure" ]]; then
                    echo "❌ CI failed"
                    exit 1
                  fi
                  echo "✅ CI passed"
