name: CI

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Restore Turborepo cache
              uses: actions/cache@v4
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ hashFiles('turbo.json', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-

            - name: Run ESLint
              run: npx turbo run lint

    format:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Check Prettier formatting
              run: npm run format:check

    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Run security audit
              run: npm audit

    type-check:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Restore Turborepo cache
              uses: actions/cache@v4
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ hashFiles('turbo.json', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-

            - name: Type check with TypeScript
              run: npx turbo run type-check

    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Restore Turborepo cache
              uses: actions/cache@v4
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ hashFiles('turbo.json', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-

            - name: Build packages
              run: npm run build

            - name: Verify core executable exists
              run: test -f packages/core/dist/server.js

            - name: Verify dashboard build exists
              run: test -f packages/dashboard/build/index.html

            - name: Upload core executable artifact
              uses: actions/upload-artifact@v4
              with:
                  name: devflow-executable
                  path: packages/core/dist/server.js
                  retention-days: 7

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Restore Turborepo cache
              uses: actions/cache@v4
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ hashFiles('turbo.json', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-

            - name: Install Playwright browsers
              run: npx playwright install --with-deps

            - name: Run core tests
              run: npm run test:core

            - name: Run dashboard tests
              run: npm run test:dashboard

    circular-deps:
        name: Circular Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 2

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'

            - name: Restore npm dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-

            - name: Install dependencies
              run: npm ci

            - name: Restore Turborepo cache
              uses: actions/cache@v4
              with:
                  path: .turbo
                  key: ${{ runner.os }}-turbo-${{ hashFiles('turbo.json', 'package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-turbo-

            - name: Check for circular dependencies
              run: npx turbo run check:circular:ci --filter=devflow-mcp

    ci-status:
        name: CI Status
        runs-on: ubuntu-latest
        needs:
            [
                lint,
                format,
                type-check,
                build,
                test,
                security-audit,
                circular-deps,
            ]
        if: always()
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check CI status
              run: |
                  if [[ "${{ needs.lint.result }}" == "failure" || \
                        "${{ needs.format.result }}" == "failure" || \
                        "${{ needs.type-check.result }}" == "failure" || \
                        "${{ needs.build.result }}" == "failure" || \
                        "${{ needs.test.result }}" == "failure" || \
                        "${{ needs.security-audit.result }}" == "failure" || \
                        "${{ needs.circular-deps.result }}" == "failure" ]]; then
                    echo "❌ CI failed"
                    exit 1
                  fi
                  echo "✅ CI passed"
