name: CI

on:
    push:
        branches:
            - main
            - develop
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read
    checks: write
    pull-requests: write

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run lint

    format:
        name: Format
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check Prettier formatting
              run: bun run format:check

    security-audit:
        name: Security Audit
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run security audit
              run: bun audit

    type-check:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Type check with TypeScript
              run: bun run type-check

    build:
        name: Build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build packages
              run: bun run build

            - name: Verify core executable exists
              run: test -f packages/core/dist/server.js

            - name: Verify dashboard build exists
              run: test -f packages/dashboard/build/index.html

            - name: Upload core executable artifact
              uses: actions/upload-artifact@v4
              with:
                  name: devflow-executable
                  path: packages/core/dist/server.js
                  retention-days: 7

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests
              run: bun run test

            - name: Run test coverage
              run: bun run test:coverage

            - name: Upload coverage artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: packages/core/coverage/

    circular-deps:
        name: Circular Dependencies
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: 1.3.2

            - name: Restore Bun dependencies cache
              uses: actions/cache@v4
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Check for circular dependencies
              run: bun run --filter devflow-mcp check:circular:ci

    ci-status:
        name: CI Status
        runs-on: ubuntu-latest
        needs:
            [
                lint,
                format,
                type-check,
                build,
                test,
                security-audit,
                circular-deps,
            ]
        if: always()
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Check CI status
              run: |
                  if [[ "${{ needs.lint.result }}" == "failure" || \
                        "${{ needs.format.result }}" == "failure" || \
                        "${{ needs.type-check.result }}" == "failure" || \
                        "${{ needs.build.result }}" == "failure" || \
                        "${{ needs.test.result }}" == "failure" || \
                        "${{ needs.security-audit.result }}" == "failure" || \
                        "${{ needs.circular-deps.result }}" == "failure" ]]; then
                    echo "❌ CI failed"
                    exit 1
                  fi
                  echo "✅ CI passed"
